</head>
<body id="nv_{$_G['basescript']}" class="$bodyClass" style="$bodystyle" data-theme="$_G['cookie']['the_site_theme']" data-sidebarbg="$_G['cookie']['the_sidebar_bg']" data-headerbg="$_G['cookie']['the_header_bg']" data-logobg="$_G['cookie']['the_logo_bg']">
<div id="append_parent" style="z-index:99999;"></div>
<div id="ajaxwaitid" style="z-index:99999;"></div>
<aside class="bs-left-container">
  <!--{template lyear:lyear_header_left}-->
    <div class="bs-left-container-info border-end lyear-scroll">
      <nav class="sidebar-main">
        <!--{template lyear:lyear_left}-->
      </nav>
      <div class="sidebar-footer">
        <p class="copyright text-muted">
        <!--{template lyear:copyright}-->
        </p>
      </div>
    </div>
  </aside>
  <div class="left-drager">
  </div>
  <header class="bs-top-container">
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container-fluid">
        <div class="navbar-left">
          <div class="lyear-aside-toggler">
          <span class="lyear-toggler-bar"></span>
          <span class="lyear-toggler-bar"></span>
          <span class="lyear-toggler-bar"></span>
          </div>
        </div>
        <button class="navbar-toggler header-navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbarText" style="">
          <!--{template lyear:lyear_header_search}-->
          <ul class="navbar-right d-flex align-items-center justify-content-end">
            <!--{template lyear:lyear_header_right}-->
            <!--切换主题配色-->
            <li class="dropdown dropdown-skin">
              <a data-toggle="dropdown" class="nav-link">
                <i class="mdi mdi-palette fs-4"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" data-stopPropagation="true">
              <li class="lyear-skin-title"><p>{lang theme}</p></li>
              <li class="lyear-skin-li clearfix">
                <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="site_theme" id="site_theme_1" value="default" checked="checked">
                <label class="form-check-label" for="site_theme_1"></label>
                </div>
                <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="site_theme" id="site_theme_2" value="color_2">
                <label class="form-check-label" for="site_theme_2"></label>
                </div>
                <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="site_theme" id="site_theme_3" value="color_3">
                <label class="form-check-label" for="site_theme_3"></label>
                </div>
                <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="site_theme" id="site_theme_4" value="color_4">
                <label class="form-check-label" for="site_theme_4"></label>
                </div>
                <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="site_theme" id="site_theme_5" value="color_5">
                <label class="form-check-label" for="site_theme_5"></label>
                </div>
                <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="site_theme" id="site_theme_6" value="color_6">
                <label class="form-check-label" for="site_theme_6"></label>
                </div>
                <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="site_theme" id="site_theme_7" value="color_7">
                <label class="form-check-label" for="site_theme_7"></label>
                </div>
                <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="site_theme" id="site_theme_8" value="dark">
                <label class="form-check-label" for="site_theme_8"></label>
                </div>
                </li>
              <li class="lyear-skin-title"><p>LOGO</p></li>
              <li class="lyear-skin-li clearfix">
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="logo_bg" id="logo_bg_1" value="default" checked="checked">
              <label class="form-check-label" for="logo_bg_1"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="logo_bg" id="logo_bg_2" value="color_2">
              <label class="form-check-label" for="logo_bg_2"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="logo_bg" id="logo_bg_3" value="color_3">
              <label class="form-check-label" for="logo_bg_3"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="logo_bg" id="logo_bg_4" value="color_4">
              <label class="form-check-label" for="logo_bg_4"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="logo_bg" id="logo_bg_5" value="color_5">
              <label class="form-check-label" for="logo_bg_5"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="logo_bg" id="logo_bg_6" value="color_6">
              <label class="form-check-label" for="logo_bg_6"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="logo_bg" id="logo_bg_7" value="color_7">
              <label class="form-check-label" for="logo_bg_7"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="logo_bg" id="logo_bg_8" value="color_8">
              <label class="form-check-label" for="logo_bg_8"></label>
              </div>
              </li>
              <li class="lyear-skin-title"><p>{lang header}</p></li>
              <li class="lyear-skin-li clearfix">
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="header_bg" id="header_bg_1" value="default" checked="checked">
              <label class="form-check-label" for="header_bg_1"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="header_bg" id="header_bg_2" value="color_2">
              <label class="form-check-label" for="header_bg_2"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="header_bg" id="header_bg_3" value="color_3">
              <label class="form-check-label" for="header_bg_3"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="header_bg" id="header_bg_4" value="color_4">
              <label class="form-check-label" for="header_bg_4"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="header_bg" id="header_bg_5" value="color_5">
              <label class="form-check-label" for="header_bg_5"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="header_bg" id="header_bg_6" value="color_6">
              <label class="form-check-label" for="header_bg_6"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="header_bg" id="header_bg_7" value="color_7">
              <label class="form-check-label" for="header_bg_7"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="header_bg" id="header_bg_8" value="color_8">
              <label class="form-check-label" for="header_bg_8"></label>
              </div>
              </li>
              <li class="lyear-skin-title"><p>{lang sidebar}</p></li>
              <li class="lyear-skin-li clearfix">
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="sidebar_bg" id="sidebar_bg_1" value="default" checked="checked">
              <label class="form-check-label" for="sidebar_bg_1"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="sidebar_bg" id="sidebar_bg_2" value="color_2">
              <label class="form-check-label" for="sidebar_bg_2"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="sidebar_bg" id="sidebar_bg_3" value="color_3">
              <label class="form-check-label" for="sidebar_bg_3"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="sidebar_bg" id="sidebar_bg_4" value="color_4">
              <label class="form-check-label" for="sidebar_bg_4"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="sidebar_bg" id="sidebar_bg_5" value="color_5">
              <label class="form-check-label" for="sidebar_bg_5"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="sidebar_bg" id="sidebar_bg_6" value="color_6">
              <label class="form-check-label" for="sidebar_bg_6"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="sidebar_bg" id="sidebar_bg_7" value="color_7">
              <label class="form-check-label" for="sidebar_bg_7"></label>
              </div>
              <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="sidebar_bg" id="sidebar_bg_8" value="color_8">
              <label class="form-check-label" for="sidebar_bg_8"></label>
              </div>
              </li>
              </ul>
            </li>
            <!--{if !$_G['setting']['bbclosed'] || !$_G['adminid'] ==0}-->
            <li>
            <a href="javascript:;" id="desktop_app" data-href="index.php?mod=system&template=1&op=app_ajax&operation=app" class="app_popup_icon nav-link js-popbox" role="button" data-placement="bottom" data-trigger="focus" data-auto-adapt="true" data-toggle="popover"><span class="mdi mdi-apps fs-4" title="{lang application}"></span></a>
            </li>
            <li>
              <a href="javascript:;" id="dzz_notification" data-href="index.php?mod=system&template=1&op=notification&filter=new" class="animations-box position-relative nav-link navbar-notice js-popbox" role="button" data-placement="bottom" data-trigger="focus" data-auto-adapt="true" data-toggle="popover">
              <span class="mdi mdi-bell-outline fs-4" title="{lang panel_notice_title}"></span>
              <span class="position-absolute translate-middle badge bg-danger rounded-pill d-none">&nbsp;</span>
              </a>
            </li>
            <!--{/if}-->
            <li>
              <a href="javascript:;" class="nav-link js-popbox user-select-none" data-href="user.php?mod=space&template=1&op=navmenu&modname={MOD_NAME}" role="button" data-placement="bottom" data-trigger="focus" data-auto-adapt="true" data-toggle="popover">
                <!--{if $_G['uid']}-->
                {eval echo avatar_block($_G['uid']);}
                <!--{else}-->
                <span class="Topcarousel img-avatar" style="background:#007bff;background:var(--bs-primary)" title="{lang login}">{lang login}</span>
                <!--{/if}-->
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>
<script type="text/javascript">
jQuery(document).ready(function(e) {
    _header.init('{FORMHASH}');//初始化头部效果
    _notice.getNotificationCount();
});

var _notice = {
    flashStep: 1,//标题闪烁的步数
    checkurl: 'index.php?mod=system&op=notification&filter=checknew',
    normalTitle: document.title,
    flashTimer: null, // 存储标题闪烁定时器，便于销毁
    pollTimer: null,  // 存储轮询定时器，便于销毁
    
    // 获取通知数量
    getNotificationCount: function() {
        var self = this;
        jQuery.getJSON(self.checkurl)
            .done(function(json) {
                var sum = parseInt(json.sum) || 0;
                self.showTips(sum);
                // 清除旧的轮询定时器，避免重复创建
                if (self.pollTimer) clearTimeout(self.pollTimer);
                // 仅当timeout有效时，创建新的轮询定时器
                if (json.timeout > 0 && json.timeout >= 1000) { // 限制最小间隔1秒
                    self.pollTimer = setTimeout(function() {
                        self.getNotificationCount();
                    }, json.timeout);
                }
            })
            .fail(function() {
                // 请求失败时，延迟重试（默认10秒后）
                if (self.pollTimer) clearTimeout(self.pollTimer);
                self.pollTimer = setTimeout(function() {
                    self.getNotificationCount();
                }, 10000);
            });
    },
    
    // 显示通知提示
    showTips: function(sum) {
        if (sum > 0) {
            jQuery('#dzz_notification>span.badge').html(sum).removeClass('d-none');
            jQuery('#dzz_notification>span.dzz').hide();
            // 启用标题闪烁（仅当有新通知且窗口未激活时）
            if (!document.hasFocus()) {
                this.flashTitle();
            }
        } else {
            jQuery('#dzz_notification>span.badge').addClass('d-none');
            jQuery('#dzz_notification>span.dzz').show();
            // 停止标题闪烁
            this.stopFlashTitle();
        }
    },
    
    // 标题闪烁
    flashTitle: function() {
        var self = this;
        // 先停止旧的闪烁定时器，避免叠加
        self.stopFlashTitle();
        
        // 检测窗口是否激活
        var CurrentActive = document.hasFocus();
        if (CurrentActive) {
            document.title = self.normalTitle;
            return;
        }
        
        self.flashTimer = setInterval(function() {
            self.flashStep++;
            if (self.flashStep === 3) self.flashStep = 1;
            if (self.flashStep === 1) {
                document.title = "【您有新的通知】";
            } else {
                document.title="【$_G['setting']['sitename']】";
            }
        }, 500);
    },
    
    // 停止标题闪烁
    stopFlashTitle: function() {
        if (this.flashTimer) {
            clearInterval(this.flashTimer);
            this.flashTimer = null;
            document.title = this.normalTitle;
            this.flashStep = 1;
        }
    },
    
    // 销毁所有定时器
    destroy: function() {
        this.stopFlashTitle();
        if (this.pollTimer) {
            clearTimeout(this.pollTimer);
            this.pollTimer = null;
        }
    }
};

// 窗口激活时，停止标题闪烁
jQuery(window).on('focus', function() {
    _notice.stopFlashTitle();
});
</script>